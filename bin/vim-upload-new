#!/usr/bin/env perl
# vim:fdm=marker:fdl=0:
use VIM::Uploader;
#use File::Temp 'tempfile';
use Cwd;
my $dist = shift;
$dist = abs_path( $dist );

#my ($fh, $filename) = tempfile();
my $pwd = qx(pwd);
my $basename = qx(basename $pwd);
my $upload_template = "$basename.upload";

if( ! -e $upload_template ) {
# {{{
    open FH, ">" , $upload_template;
    print FH <<END;
script_name:

    [script name]

script_file:

    $dist

script_type:

    color scheme
    ftplugin
    game
    indent
    syntax
    utility
    patch

vim_version:

    5.7
    6.0
    7.0
    7.2

script_version: 

    0.1

summary:

    [summary]

description:

    [description]

install_details:

    [install details]

END
    close FH;
    system( qq(vim $filename) );
# }}}
}

open FH , "<" , $filename;
local $/;
my $content = <FH>;
close FH;

# parse content
my @lines = split /\n/,$content;

my $section;
my %parts;
my @buffer;

sub flush_buffer {
    my ($section) = @_;
    if( @buffer and $section ) {
        $parts{ $section } = join "\n", @buffer;
        @buffer = ( );
    }
}

for my $l ( @lines ) {
    if ( $l =~ m{^(\w+):\s*$} ) {
        flush_buffer( $section );
        $section = $1;
        next;
    }
    else {
        push @buffer,$l;
    }
}
flush_buffer( $section );

# oneline arguments
for ( qw(script_name script_file script_type vim_version script_version) ) {
    $parts{ $_ } =~ s{\n}{}g;
    $parts{ $_ } =~ s{^\s*}{}g;
    $parts{ $_ } =~ s{\s*$}{}g;
}

$parts{ script_name } =~ s{\s}{-}g;

my $uploader = VIM::Uploader->new();
$uploader->login();
$uploader->upload_new( %parts );
print "Done";
